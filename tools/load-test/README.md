# Hydra Migration Load Tool

Tool for generating load against a Hydra/Kratos deployment to test migration scenarios. It supports creating a set of test identities and clients, and then running a concurrent load test that performs logins, including TOTP handling.

## Installation

Requires Python 3.8+.

```bash
pip install .
```

## Development

Install development dependencies:

```bash
pip install -e ".[dev]"
```

## Usage

The tool has two main commands: `setup` and `run`.

### 1. Setup

Generates a dataset of users and clients to be used for the load test. This creates a JSON file containing the generated identities and OAuth2 clients.

```bash
hydra-migration-load setup --num-users 1000 --num-clients 50 --output setup.json
```

**Arguments:**
- `--num-users`: Number of users to generate (default: 1000).
- `--num-clients`: Number of OAuth2 clients to generate (default: 50).
- `--output`: Output file path for the generated data (default: `setup.json`).

### 2. Run Load Test

Executes the load test using the identities and clients generated in the setup step.

```bash
hydra-migration-load run --setup-file setup.json --concurrency 50 --logins-per-user 10
```

**Arguments:**
- `--setup-file`: Path to the JSON file generated by the setup command (default: `setup.json`).
- `--logins-per-user`: Number of times each user should log in (default: 10).
- `--concurrency`: Number of concurrent users/tasks to run (default: 50).
- `--enable-refresh`: Enable token refresh flow (flag).

## Configuration

The tool targets default endpoints for Hydra and Kratos, but these can be overridden via CLI arguments for both `setup` and `run` commands.

### Endpoint Arguments

You can override any of the following endpoints:

- `--kratos-admin`: URL for Kratos Admin API (default: `http://10.152.183.178:4434`)
- `--kratos-public`: URL for Kratos Public API (default: `http://10.152.183.178:4433`)
- `--hydra-admin`: URL for Hydra Admin API (default: `http://10.152.183.55:4445/admin`)
- `--hydra-public`: URL for Hydra Public API (default: `https://10.64.140.43`)
- `--login-ui`: Full URL to the Login UI (default: `https://10.64.140.43/ui/login`)
- `--login-ui-base-url`: Base URL for the Login UI (default: `https://10.64.140.43`)

**Example:**

```bash
hydra-migration-load run \
  --hydra-public https://hydra.example.com \
  --login-ui https://auth.example.com/login
```
