name: Pull Request Workflow

on:
  workflow_call:
    inputs:
      container-name:
        description: Name of the application container to get logs from
        required: false
        type: string
      charm-config-path:
        description: Path to the application config file
        required: false
        type: string
      use-charmcraftcache:
        description: Enable usage of charmcraftcache
        required: false
        default: false
        type: boolean
      node-size:
        description: Size of the self-hosted node (one of medium, large or xlarge) to run the integration tests
        type: string
        required: false
        default: large
      tox-unit-test-targets:
        description: Comma separated list of tox targets needed to perform unit-tests
        type: string
        required: false
        default: unit
      tox-integration-test-targets:
        description: Comma separated list of tox targets needed to perform integration-tests
        type: string
        required: false
        default: integration
      use-canonical-k8s:
        type: boolean
        description: Whether to use canonical k8s instead of microk8s
        default: false
      modules:
        description: |
          List of testing modules to run the tests in JSON format, i.e. '["foo", "bar"]'.
          Each element will be passed to pytest through tox as -k argument.
        type: string
        default: '["test_charm.py"]'
    secrets:
      CHARMCRAFT_CREDENTIALS:
        required: false

jobs:
  linting:
    name: Linting
    uses: ./.github/workflows/_charm-linting.yaml

  unit-test:
    name: Unit Tests
    uses: ./.github/workflows/_charm-tests-unit.yaml
    with:
      tox-unit-test-targets: ${{ inputs.tox-unit-test-targets }}
    needs:
      - linting

  node-size-validation:
    runs-on: ubuntu-latest
    name: Input Node Size validation
    steps:
      - name: Validate node size variable
        if: ${{ !contains(fromJSON('["medium", "large", "xlarge"]'), inputs.node-size) }}
        run: exit 1
    needs:
      - linting
      - unit-test

  integration-test:
    name: Integration Tests
    uses: canonical/operator-workflows/.github/workflows/integration_test.yaml@main
    needs:
      - linting
      - unit-test
      - node-size-validation
    secrets: inherit
    with:
      use-canonical-k8s: ${{ inputs.use-canonical-k8s }}
      provider: ${{ inputs.use-canonical-k8s && 'k8s' || 'microk8s' }}
      channel: ${{ inputs.use-canonical-k8s && 'edge' || '1.32-strict/stable' }}
      microk8s-addons: ${{ inputs.use-canonical-k8s && '' || 'dns hostpath-storage metallb:10.64.140.43-10.64.140.49' }}
      extra-arguments: |
        --kube-config=~/.kube/config
      juju-channel: 3.6/stable
      self-hosted-runner: true
      self-hosted-runner-label: ${{ inputs.node-size }}
      self-hosted-runner-image: jammy
      test-tox-env: ${{ inputs.tox-integration-test-targets }}
      modules: ${{ inputs.modules }}
      charmcraftcache: ${{ inputs.use-charmcraftcache }}
